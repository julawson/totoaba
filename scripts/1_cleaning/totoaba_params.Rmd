## Calculating Parameters for Totoaba Model ##

## All Values need to be in the units of totoaba tonnes ##

```{r load libraries}
library(here)
library(tidyverse)

```

```{r loading data}

dat_aqm <- read.csv(here("data","andrew","dat_aqm.csv")) #Aquaculture Mortality by Age (in Months)
dat_b <- read.csv(here("data","andrew","dat_b.csv")) #Biomass by Age (INAPESCA)
dat_bc <- read.csv(here("data","andrew","dat_bc.csv")) #Biomass, Number of Individuals by Year (INAPESCA) check?
dat_bio <- read.csv(here("data","andrew","dat_bio.csv")) #Biomass, Number of Individuals by Age (in Years) (INAPESCA)
dat_inapesca_bio <- read.csv(here("data","andrew","dat_inpesca_bio.csv")) #Age-Length-Weight Relationships (INAPESCA 2020)
dat_p <- read.csv(here("data","andrew","dat_p.csv")) #Price-quantity data (OG Paper)
dat_pars <- read.csv(here("data","andrew","dat_pars.csv")) %>% mutate(across(4:6, round, 6)) #Overall parameters (OG Paper)

```

```{r growth parameters}

# Define the parameters for the biological resource
r <- 0.23 #intrinsic rate of population increase ** (Needed: Ere)
k <- 20226 #carrying capacity (biomass in t)
theta <- 0.001 #catchability (needs to be effort per tonne of biomass) ** (Needed: Ere)

```


```{r poaching effort}

# Define the parameters for the poaching effort
# Fixed parameters
n <- 0.1
theta <- 2 #cost parameter, assumed to be 2 (fixed)
z <- 2 * W 

# Estimated parameters, poaching
P <- 155.916 # exogenous market price per unit of output ($USD per tonne of totoaba biomass)
W <- 3588.436 # poaching cost parameter, increases proportionally with effort ($USD per tonne of totoaba biomass), median value 1794.716
c <- #cost of trading, all the costs associated with the transportation and final sale of wild animal products
s <- 58.0895 # price paid to poachers ($USD per tonne of totoaba biomass)

# Estimated parameters, farming
v <- 18282.1 # farming cost parameter ($USD per tonne of totoaba biomass)
lambda <- 0.75 #gamma

alpha <- 84.39 #inverse demand parameter
beta <- 16.41 #inverse demand parameter
  
initial_x <- 1400 #t of totoaba in 2017
initial_E <- 2.878333 # Catch-per-unit-effort, Totoaba (tonnes) per Vessel per Year (Median value is 0.4), considering the fishery is active for six months of the year

```

```{r calculating P and s}

P_par <- read.csv(here("data","P_par.csv")) # Price in end-markets, from INAPESCA Fig 4.4
s_par <- read.csv(here("data","s_par.csv"))  # Price paid to fishers on beaches, from INAPESCA Fig 4.4

### Calculate s, price paid to poachers ($USD per tonne of totoaba biomass)
# We assume each totoaba is an average weight of 26 kg (and has a 500 gram buche) (this is reflected by averages reported by INAPESCA 2020)

# Need x to be weight in tonnes of fresh totoaba
# Need y to be price per tonne of fish totoaba

# Transforming to weight of totoaba

# Create an equation to transform buche weight to fish weight
dat_inapesca_bio <- dat_inapesca_bio %>% 
  mutate(weight_buche_g = (weight*0.0161)*1000)

fish_to_buche_equation <- lm(weight_buche_g ~ weight, dat=dat_inapesca_bio)
summary(fish_to_buche_equation)

# Swim bladder wet weight makes up 1.61% of totoaba weight

# 1. Changing swim bladder weight_g_fresh to totoaba weight, 
s_par <- s_par %>% 
  mutate(totoaba_weight_g = weight_g_fresh/0.0161) %>% 
  mutate(totoaba_weight_kg = totoaba_weight_g/1000) %>% 
  mutate(totoaba_weight_t = totoaba_weight_kg/1000) 

lm <- lm(price_per_tonne~totoaba_weight_t, data=s_par)
summary(lm)

# Final parameter for s, fishers paid 58.0895 USD per tonne of totoaba

### Now calculating P, exogenous market price per unit of output ($USD per tonne of totoaba biomass)

# Need x to be weight in tonnes of fresh totoaba
# Need y to be price per tonne of totoaba

P_par <- P_par %>% 
  mutate(weight_g_wet = weight_g_dried/0.31) %>%
  mutate(totoaba_weight_g = weight_g_wet/0.0161) %>% 
  mutate(totoaba_weight_kg = totoaba_weight_g/1000) %>% 
  mutate(totoaba_weight_t = totoaba_weight_kg/1000) 

lm2 <- lm(price_per_tonne~totoaba_weight_t, data=P_par)
summary(lm2)

# Estimating price premium for Ere

lm_P_par_kg <- lm(price_per_kg_dried ~ weight_kg_dried, data=P_par)
summary(lm_P_par_kg)

```

```{r calculating effort}

# Effort measured in number of vessels
# Therefore, CPUE is Totoabas/Vessels, or tonnes of Totoaba/Vessel

# Calculating initial Aggregate Poaching Effort, E
E_par <- read.csv(here("data","E_par.csv")) # Effort breakdown, from INAPESCA Fig 4.2
w_par <- read.csv(here("data","w_par.csv")) # Cost data, from Buche Bros

E_par <- E_par %>% 
  mutate(days_permonth = (days_perweek*weeks_permonth)) %>% 
  mutate(sets_permonth = (days_permonth*sets_pervessel_day)) %>% 
  mutate(sets_vessels_permonth = vessels*sets_permonth) %>% 
  mutate(totoaba_per_vessel = totoabas_year/vessels) %>% 
  mutate_at(vars(totoaba_per_vessel), ~replace(., is.nan(.), 0)) %>% 
  mutate(totoaba_t_per_vessel = biomass_captured_t/vessels) %>% 
  mutate_at(vars(totoaba_t_per_vessel), ~replace(., is.nan(.), 0))

E_val <- E_par %>% 
  summarize(median=median(totoaba_t_per_vessel),
            mean=mean(totoaba_t_per_vessel))

# W parameter, proportional increase in cost per unit of effort
# x axis should be effort (number of vessels)
# y axis should be cost per vessel

#Step one, get all operating costs into cost per tonne of totoaba

w_par_ops <- w_par %>% 
  mutate(operating_cost_permonth = (bribe_permonth+ foodfuel_permonth + gear_replacement_permonth)) %>% #monthly operating costs
  mutate(cost_per_t_totoaba = operating_cost_permonth/totoaba_t_per_vessel) %>%  #operating cost per tonne of totoaba
  mutate(wages_per_t_totoaba = price_poachers_per_t*0.75) %>% 
  mutate(running_cost = cost_per_t_totoaba+wages_per_t_totoaba) %>% 
  mutate_at(vars(running_cost), ~replace(., is.nan(.), 0)) 

w_par_val <- w_par_ops %>% 
  summarize(median=median(running_cost),
            mean=mean(running_cost))

# Step two, add in probability of enforcement action (i.e. fines, gear, or vessel confiscation)
# For now, leaving this out, because this is a fleet-wide probability, rather than per vessel.


```

```{r farming costs}

v_par <- read.csv(here("data","v_par.csv")) # Farming cost data, from Buche Bros

v_par <- v_par %>% 
  mutate(operating_costs = (maintenance_year+cleaning_year+vessel_maintenance_year+fuel_year+feed+labor+facility_lease+admin)) %>% 
  mutate(operating_costs/capacity_per_sphere_t)

```

```{r demand curve}

lm(p~q, data=dat_p)

```
